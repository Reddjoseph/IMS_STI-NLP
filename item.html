<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Item Details</title>
  <link rel="stylesheet" href="inventory.css" />
</head>
<body>
  <div class="container">
    <h1>Item Details</h1>

    <!-- Item info -->
    <ul class="info-list">
      <li><strong>ID:</strong> <span id="item-id"></span></li>
      <li><strong>Name:</strong> <span id="item-name"></span></li>
      <li><strong>Laboratory:</strong> <span id="item-lab"></span></li>
      <li><strong>Condition:</strong> <span id="item-condition"></span></li>
      <li><strong>Date Added:</strong> <span id="item-date"></span></li>
      <li><strong>Image:</strong><br/><img id="item-image" style="max-width:300px; margin-top:10px;" /></li>
    </ul>

    <!-- Reports Section -->
    <h2 style="margin:40px auto 15px auto; max-width:900px;">Reports for this Item</h2>
    <table class="inventory-table">
      <thead>
        <tr>
          <th>Ticket ID</th>
          <th>Concern</th>
          <th>Description</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="tickets-body"></tbody>
    </table>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
    import { getFirestore, doc, getDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MSG_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    // Init Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Get item ID from URL
    const params = new URLSearchParams(window.location.search);
    const itemId = params.get("id");

    // Fetch and display item details
    async function fetchAndDisplayItem() {
      if (!itemId) return;

      const itemRef = doc(db, "inventory", itemId);
      const snap = await getDoc(itemRef);

      if (snap.exists()) {
        const data = snap.data();
        document.getElementById("item-id").textContent = itemId;
        document.getElementById("item-name").textContent = data.Name || "";
        document.getElementById("item-lab").textContent = data.Laboratory || "";
        document.getElementById("item-condition").textContent = data.Condition || "";
        document.getElementById("item-date").textContent = data.DateAdded || "";
        if (data.Image) {
          document.getElementById("item-image").src = data.Image;
        }

        // Fetch related tickets by item name
        fetchTicketsForItem(data.Name || "");
      }
    }

    // Fetch tickets for this item
    async function fetchTicketsForItem(itemName) {
      const ticketsBody = document.getElementById("tickets-body");
      ticketsBody.innerHTML = `<tr><td colspan="4">Loading reports...</td></tr>`;

      try {
        const ticketsRef = collection(db, "tickets");
        const q = query(ticketsRef, where("item", "==", itemName));
        const snapshot = await getDocs(q);

        if (snapshot.empty) {
          ticketsBody.innerHTML = `<tr><td colspan="4">No reports found for this item.</td></tr>`;
          return;
        }

        ticketsBody.innerHTML = "";
        snapshot.forEach(docSnap => {
          const t = docSnap.data();
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${docSnap.id}</td>
            <td>${t.concern || ""}</td>
            <td>${t.description || ""}</td>
            <td style="font-weight:600;">${t.status || "Pending"}</td>
          `;
          ticketsBody.appendChild(row);
        });
      } catch (err) {
        console.error("Error fetching tickets:", err);
        ticketsBody.innerHTML = `<tr><td colspan="4">Error loading reports.</td></tr>`;
      }
    }

    fetchAndDisplayItem();
  </script>
</body>
</html>
