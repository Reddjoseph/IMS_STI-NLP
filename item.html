<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Item Details</title>
  <link rel="stylesheet" href="inventory.css">
  <style>
    .ticket-status-dropdown {
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
    }
    .ticket-status-dropdown.pending {
      background: #dbeafe;
      color: #1e40af;
    }
    .ticket-status-dropdown.resolved {
      background: #dcfce7;
      color: #166534;
    }
    .ticket-status-dropdown.closed {
      background: #e5e7eb;
      color: #374151;
    }
    .editable-description {
      width: 100%;
      border: 1px solid transparent;
      background: transparent;
      padding: 4px;
      font-size: 0.9rem;
      color: #000;
    }
    .editable-description:focus {
      border: 1px solid #2563eb;
      background: #f9fafb;
      outline: none;
    }
  </style>
</head>
<body>
  <div class="item-container">
    <!-- Item details -->
    <div class="item-card">
      <img id="item-image" src="https://via.placeholder.com/350x250?text=No+Image+Available" alt="Item Image">
      <div class="item-info">
        <h2 id="item-name">Item Name</h2>
        <p><strong>ID:</strong> <span id="item-id"></span></p>
        <p><strong>Laboratory:</strong> <span id="item-lab"></span></p>
        <p><strong>Condition:</strong> <span id="item-condition"></span></p>
        <p><strong>Date Added:</strong> <span id="item-date"></span></p>
      </div>
    </div>

    <!-- Reports -->
    <div class="item-reports">
      <h3>Reports</h3>
      <table class="reports-table">
        <thead>
          <tr>
            <th>Ticket ID</th>
            <th>Concern</th>
            <th>Description</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="item-reports-body"></tbody>
      </table>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAw2rSjJ3f_S98dntbsyl9kyXvi9MC44Dw",
      authDomain: "fir-inventory-2e62a.firebaseapp.com",
      projectId: "fir-inventory-2e62a",
      storageBucket: "fir-inventory-2e62a.firebasestorage.app",
      messagingSenderId: "380849220480",
      appId: "1:380849220480:web:5a43b227bab9f9a197af65",
      measurementId: "G-ERT87GL4XC"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Get item ID from URL
    const params = new URLSearchParams(window.location.search);
    const itemId = params.get('id');
    let itemName = '';

    // Load item details
    async function loadItemDetails() {
      const doc = await db.collection('inventory').doc(itemId).get();
      if (doc.exists) {
        const data = doc.data();
        itemName = data.Name || '';
        document.getElementById('item-id').textContent = doc.id;
        document.getElementById('item-name').textContent = itemName;
        document.getElementById('item-lab').textContent = data.Laboratory || 'N/A';
        document.getElementById('item-condition').textContent = data.Condition || 'Unknown';
        document.getElementById('item-date').textContent = data.DateAdded || 'N/A';
        document.getElementById('item-image').src = data.ImageURL || "https://via.placeholder.com/350x250?text=No+Image+Available";

        loadItemReports();
      }
    }

    // Load tickets linked to this item
    async function loadItemReports() {
      const reportsBody = document.getElementById('item-reports-body');
      reportsBody.innerHTML = '';

      const snapshot = await db.collection('tickets')
        .where('item', '==', itemName)
        .get();

      snapshot.forEach(doc => {
        const data = doc.data();
        const tr = document.createElement('tr');
        const statusClass = (data.status || 'Pending').toLowerCase();

        tr.innerHTML = `
          <td>${doc.id}</td>
          <td>${escapeHtml(data.concern)}</td>
          <td>
            <input 
              type="text" 
              class="editable-description" 
              value="${escapeHtml(data.description || '')}" 
              data-id="${doc.id}">
          </td>
          <td>
            <select class="ticket-status-dropdown ${statusClass}" data-id="${doc.id}">
              <option value="Pending" ${data.status === 'Pending' ? 'selected' : ''}>Pending</option>
              <option value="Resolved" ${data.status === 'Resolved' ? 'selected' : ''}>Resolved</option>
              <option value="Closed" ${data.status === 'Closed' ? 'selected' : ''}>Closed</option>
            </select>
          </td>
        `;
        reportsBody.appendChild(tr);
      });

      attachListeners();
    }

    // Attach listeners to inputs & dropdowns
    function attachListeners() {
      document.querySelectorAll('.editable-description').forEach(input => {
        input.addEventListener('blur', async (e) => {
          const ticketId = e.target.dataset.id;
          const newDesc = e.target.value.trim();
          console.log(`Updating description for ${ticketId}: ${newDesc}`);
          try {
            await db.collection('tickets').doc(ticketId).update({ description: newDesc });
          } catch (err) {
            console.error('Error updating description:', err);
          }
        });
      });

      document.querySelectorAll('.ticket-status-dropdown').forEach(select => {
        select.addEventListener('change', async (e) => {
          const ticketId = e.target.dataset.id;
          const newStatus = e.target.value;
          console.log(`Updating status for ${ticketId}: ${newStatus}`);
          try {
            await db.collection('tickets').doc(ticketId).update({ status: newStatus });
            e.target.classList.remove('pending', 'resolved', 'closed');
            e.target.classList.add(newStatus.toLowerCase());
          } catch (err) {
            console.error('Error updating status:', err);
          }
        });
      });
    }

    // Escape HTML utility
    function escapeHtml(s = '') {
      return String(s)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }

    loadItemDetails();
  </script>
</body>
</html>
